{% extends "base.html" %}
{% block title %}
    Přidat skladbu do souboru
{% endblock %}
{% block content %}
    <main class="py-4">
        <div class="container-xl">

            <!-- Back Link -->
            {% from "macros/_back_button.html" import back_link %}
            {{ back_link("ensemble.ensemble_detail", "Zpět na detail souboru", {"ensemble_id": ensemble.id}) }}

            {% if current_semester.id not in ensemble.semester_ids %}
                <div class="alert alert-warning" role="alert">
                    <p>Soubor není aktivní v aktuálně zvoleném semestru ({{ current_semester.name }}).</p>
                    <p>Pokud jej chcete převést do dalšího semestru, použijte příkaz <b>Převést do dalšího semestru</b>
                        v sekci Semestry.</p>
                </div>
            {% endif %}

            <!-- Ensemble Info -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Přidat skladbu do souboru {{ ensemble.name }}</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label text-muted fw-semibold">Název souboru</label>
                            <div>{{ ensemble.name }}</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted fw-semibold">Obsazení</label>
                            <div>{{ ensemble.instrumentation }}</div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label text-muted fw-semibold">Aktuální semestr</label>
                        <div>{{ current_semester.name }} {{ current_semester.academic_year.name }}</div>
                    </div>
                </div>
            </div>

            <!-- Available Compositions -->
            <!-- Filter Controls -->
            {% from 'macros/_filters.jinja' import text_filter, select_filter, button_row with context %}
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <form method="get" class="p-2">
                        <div class="row g-3 align-items-end">

                            {{ text_filter(
                    label="Hledat skladbu",
                    id="composition_id",
                    name="q",
                    value=q or '',
                    placeholder="Název skladby nebo skladatele",
                    width='col-md-4'
                ) }}

                            {{ select_filter(
                    label="Nástroj v obsazení",
                    id="filter-instrument",
                    name="instrument_ids",
                    options=instruments,
                    selected_ids=instrument_filter or [],
                    multiple=True,
                    placeholder="Vyberte nástroj...",
                    width='col-md-4'
                ) }}

                            {{ button_row(show_reset=(q or instrument_filter), reset_url=url_for('ensemble.add_composition_to_ensemble', ensemble_id=ensemble.id)) }}
                        </div>
                    </form>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">Dostupné skladby</h5>
                </div>
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead class="table-light text-uppercase small text-muted">
                        <tr>
                            <th>Název skladby</th>
                            <th>Skladatel</th>
                            <th>Obsazení</th>
                            <th>Doba trvání</th>
                            <th class="text-end">Akce</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for comp in available_compositions %}
                            <tr>
                                <td>{{ comp.name }}</td>
                                <td>{{ comp.composer.full_name }}</td>
                                <td>{{ comp.chamber_instrumentation or "-" }}</td>
                                <td>{{ "%.1f"|format(comp.durata) }} min</td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-primary select-composition-btn"
                                            data-composition-id="{{ comp.id }}"
                                            data-composition-name="{{ comp.name }}">
                                        <i class="fas fa-plus me-1"></i> Přidat
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Confirmation Modal -->
            <div class="modal fade" id="CompositionSelectionModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5">Přidat skladbu do souboru</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="composition-modal-body"></div>
                        <div class="modal-footer">
                            <form method="POST" id="composition-modal-form"
                                  action="{{ url_for('ensemble.add_composition_to_ensemble',
                                    ensemble_id=ensemble.id,
                                    semester_id=current_semester.id) }}">
                                <input type="hidden" name="selected_composition_id" id="modal-composition-id">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavřít</button>
                                <button type="submit" class="btn btn-primary">Přidat</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    document.querySelectorAll(".select-composition-btn").forEach(btn => {
                        btn.addEventListener("click", function () {
                            const compositionId = this.dataset.compositionId;
                            const compositionName = this.dataset.compositionName;

                            document.getElementById("modal-composition-id").value = compositionId;
                            document.getElementById("composition-modal-body").innerHTML =
                                `Opravdu si přejete přidat skladbu <b>${compositionName}</b> do souboru {{ ensemble.name }}?`;

                            new bootstrap.Modal(document.getElementById("CompositionSelectionModal")).show();
                        });
                    });
                });
            </script>
        </div>
    </main>
    {% include "partials/_tomselect_init.html" %}

{% endblock %}
