{% extends "base.html" %}
{% block title %}
    Přidat hráče do souboru
{% endblock %}
{% block content %}
    <main class="py-4">
        <div class="container-xl">

            <!-- Back Link -->
            {% from "macros/_back_button.html" import back_link %}

            {{ back_link("ensemble.ensemble_detail", "Zpět na detail souboru", {"ensemble_id": ensemble.id}) }}

            {% if current_semester.id not in ensemble.semester_ids %}
                <div class="alert alert-warning" role="alert">
                    <p>
                        Současně prohlížený soubor není ve vámi nahlíženém období aktivní.
                    </p>
                    <p>
                        Pokud jej chcete převést do dalšího semestru, použijte v oddělení Semestry příkaz Převést do
                        dalšího semestru.
                    </p>
                </div>
            {% endif %}


            <!-- Ensemble Detail Card -->
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Přidat studenta do souboru {{ ensemble.name }} na
                        pozici {{ instrumentation.instrument.name }} </h5>
                </div>

                <div class="card-body">
                    <div class="row g-4">
                        <div class="col">
                            <label class="form-label fw-semibold text-muted">Název:</label>
                            <div>{{ ensemble.name }}</div>
                        </div>
                    </div>
                    <div class="row g-4">
                        <div class="col">
                            <label class="form-label fw-semibold text-muted">Obsazení:</label>
                            <div>{{ ensemble.instrumentation }}</div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Available Players -->
            <div class="card shadow-sm mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        Dostupní hráči v semestru {{ current_semester.name }} {{ current_semester.academic_year.name }}
                    </h5>
                </div>

                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead class="table-light text-uppercase small text-muted">
                        <tr>
                            <th>Hráč</th>
                            <th class="text-center">Zatížení</th>
                            <th class="text-end">Akce</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for player in available_players %}
                            {% set count = player.ensemble_count_in_semester(current_semester.id) %}

                            {% if count == 0 %}
                                {% set percent, color, label = (0, "bg-danger", "0") %}
                            {% elif count == 1 %}
                                {% set percent, color, label = (25, "bg-success", "1") %}
                            {% elif count == 2 %}
                                {% set percent, color, label = (50, "bg-warning text-dark", "2") %}
                            {% elif count == 3 %}
                                {% set percent, color, label = (75, "bg-info text-dark", "3") %}
                            {% else %}
                                {% set percent, color, label = (100, "bg-danger", count|string) %}
                            {% endif %}

                            {% set is_erasmus = player.student and player.student.has_erasmus_in_semester(current_semester.id) %}

                            <tr class="{% if is_erasmus %}table-secondary text-muted{% endif %}">
                                <!-- Player info -->
                                <td>
                                    <div class="fw-semibold">{{ player.last_name }} {{ player.first_name }}</div>
                                    {% if player.instrument %}
                                        <span class="badge bg-light text-dark border">
                    <i class="fas fa-music me-1"></i>{{ player.instrument.name }}
                </span>
                                    {% endif %}
                                    {% if is_erasmus %}
                                        <span class="badge bg-info ms-2">Erasmus</span>
                                    {% endif %}
                                </td>

                                <!-- Workload bar -->
                                <td class="text-center">
                                    <div class="progress" style="height: 0.75rem; width: 100px;"
                                         title="{{ count }} soubor(ů) v tomto semestru">
                                        <div class="progress-bar {{ color }}"
                                             role="progressbar"
                                             style="width: {{ percent }}%;"
                                             aria-valuenow="{{ percent }}" aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                </td>

                                <!-- Action -->
                                <td class="text-end">
                                    <button class="btn btn-sm btn-primary select-player-btn"
                                            data-player-id="{{ player.id }}"
                                            data-player-name="{{ player.last_name }} {{ player.first_name }}"
                                            {% if is_erasmus %}disabled{% endif %}>
                                        <i class="fas fa-user-plus me-1"></i> Vybrat
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>

                    </table>
                </div>
            </div>

            <!-- Reusable Modal -->
            <div class="modal fade" id="PlayerSelectionModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5">Přiřadit hráče do souboru</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="player-modal-body"></div>
                        <div class="modal-footer">
                            <form method="POST" id="player-modal-form"
                                  action="{{ url_for('ensemble.add_player_to_ensemble',
                  ensemble_id=ensemble.id,
                  ensemble_instrumentation_id=instrumentation.id,
                  mode=('student' if request.args.get('mode') == 'student' else 'guest')) }}">
                                <input type="hidden" name="selected_player_id" id="modal-player-id">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavřít</button>
                                <button type="submit" class="btn btn-primary">Přidat</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    document.querySelectorAll(".select-player-btn").forEach(btn => {
                        btn.addEventListener("click", function () {
                            const playerId = this.dataset.playerId;
                            const playerName = this.dataset.playerName;

                            document.getElementById("modal-player-id").value = playerId;
                            document.getElementById("player-modal-body").innerHTML =
                                `Opravdu si přejete přidat studenta <b>${playerName}</b> do souboru {{ ensemble.name }}?`;

                            new bootstrap.Modal(document.getElementById("PlayerSelectionModal")).show();
                        });
                    });
                });
            </script>


        </div>

    </main>
{% endblock %}
