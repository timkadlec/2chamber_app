{% extends "base.html" %}
{% block title %}Detail výjimky #{{ exception.id }}{% endblock %}

{% block content %}
<main class="py-4">
    <div class="container-xl">
        {% from "macros/_back_button.html" import back_link %}
        {{ back_link("exceptions.index", "Zpět na výjimky", request.args) }}

        <div class="card shadow-sm">
            <div class="card-header text-center">
                <h4 class="mb-0 fw-bold">Akademie múzických umění v Praze</h4>
                <small class="text-muted">Žádost o výjimku v rámci předmětu Komorní hra</small>
            </div>

            <div class="card-body p-5">
                <!-- Document heading -->
                <h5 class="text-center mb-4 text-uppercase">Protokol o výjimce</h5>

                <!-- Exception Metadata -->
                <table class="table table-borderless mb-4">
                    <tr>
                        <th style="width:25%">Číslo výjimky:</th>
                        <td>#{{ exception.id }}</td>
                    </tr>
                    <tr>
                        <th>Žádost:</th>
                        <td>
                            <a href="{{ url_for('chamber_applications.detail', application_id=exception.application.id) }}">
                                Žádost #{{ exception.application.id }}
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <th>Datum podání:</th>
                        <td>{{ exception.created_at.strftime("%d.%m.%Y %H:%M") }}</td>
                    </tr>
                    <tr>
                        <th>Podal:</th>
                        <td>{{ exception.created_by.display_name if exception.created_by else "—" }}</td>
                    </tr>
                    <tr>
                        <th>Stav:</th>
                        <td>
                            {% if exception.status == 'pending' %}
                                <span class="badge rounded-pill bg-warning text-dark">Čeká na schválení</span>
                            {% elif exception.status == 'approved' %}
                                <span class="badge rounded-pill bg-success">Schváleno</span>
                            {% elif exception.status == 'rejected' %}
                                <span class="badge rounded-pill bg-danger">Zamítnuto</span>
                            {% endif %}
                        </td>
                    </tr>
                </table>

                <!-- Reason -->
                <h6 class="fw-bold mt-4">Odůvodnění žádosti žadatelem:</h6>
                <p class="border rounded p-3 bg-light">{{ exception.reason }}</p>

                <!-- Official reviewer statement -->
                {% if exception.reviewed_by %}
                    <h6 class="fw-bold mt-4">Vyjádření posuzovatele:</h6>
                    <div class="border rounded p-4 bg-white">
                        <p>
                            Na základě posouzení žádosti č. {{ exception.application.id }},
                            podané dne {{ exception.created_at.strftime("%d.%m.%Y %H:%M") }}
                            studentem {{ exception.created_by.display_name if exception.created_by else "—" }},
                            rozhodl posuzovatel dne {{ exception.reviewed_at.strftime("%d.%m.%Y %H:%M") }} následovně:
                        </p>

                        <p>
                            Žádost o výjimku se
                            <strong>
                                {% if exception.status == 'approved' %}schvaluje{% elif exception.status == 'rejected' %}zamítá{% endif %}
                            </strong>.
                        </p>

                        {% if exception.reviewer_comment %}
                        <p><strong>Komentář posuzovatele:</strong><br>
                           {{ exception.reviewer_comment }}
                        </p>
                        {% endif %}

                        <p class="mt-3"><em>Posuzoval: {{ exception.reviewed_by.display_name }}</em></p>
                    </div>
                {% endif %}

                <!-- Decision buttons only if still pending -->
                {% if exception.status == 'pending' %}
                <div class="mt-5">
                    <h6 class="fw-bold mb-3">Rozhodnutí:</h6>
                    <div class="d-flex gap-3">
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#approveModal">
                            <i class="fas fa-check me-2"></i> Schválit
                        </button>
                        <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#rejectModal">
                            <i class="fas fa-times me-2"></i> Zamítnout
                        </button>
                    </div>
                </div>
                {% endif %}

                <!-- Approve Modal -->
                <div class="modal fade" id="approveModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <form method="post" action="{{ url_for('exceptions.exception_decision', exception_id=exception.id) }}">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Potvrdit schválení</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p>Opravdu chcete schválit tuto výjimku?</p>
                                    <div class="mb-3">
                                        <label for="approveComment" class="form-label">Komentář (volitelný)</label>
                                        <textarea class="form-control" id="approveComment" name="comment" rows="3"></textarea>
                                    </div>
                                    <input type="hidden" name="decision" value="approved">
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zrušit</button>
                                    <button type="submit" class="btn btn-success">Potvrdit schválení</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Reject Modal -->
                <div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <form method="post" action="{{ url_for('exceptions.exception_decision', exception_id=exception.id) }}">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Potvrdit zamítnutí</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p>Opravdu chcete zamítnout tuto výjimku?</p>
                                    <div class="mb-3">
                                        <label for="rejectComment" class="form-label">Komentář (volitelný)</label>
                                        <textarea class="form-control" id="rejectComment" name="comment" rows="3"></textarea>
                                    </div>
                                    <input type="hidden" name="decision" value="rejected">
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zrušit</button>
                                    <button type="submit" class="btn btn-danger">Potvrdit zamítnutí</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

            </div>
        </div>
    </div>
</main>
{% endblock %}
