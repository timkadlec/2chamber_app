{% extends "base.html" %}
{% block title %}
    Detail skladby | {{ composition.name }}
{% endblock %}
{% block content %}
    <main class="py-4">
        <div class="container-xl">

            <!-- Back link -->
            {% from "macros/_back_button.html" import back_link %}
            {% if request.args.get("nav_type") == "from_composer" %}
                {{ back_link("library.composer_detail", "Zpět na detail skladatele", {"composer_id": composition.composer.id}) }}
            {% else %}
                {{ back_link("library.compositions", "Zpět na přehled skladeb", request.args) }}
            {% endif %}

            <!-- Composition Card -->
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Detail skladby</h5>
                    <a href="{{ url_for('library.composition_edit', composition_id=composition.id, nav_type="from_composition") }}"
                       class="btn btn-sm btn-info">
                        <i class="fas fa-edit me-1"></i>Upravit skladbu
                    </a>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <!-- Left column -->
                        <div class="col-md-6">
                            <h4 class="fw-semibold mb-3">{{ composition.name }}</h4>
                            <div class="mb-2">
                                <strong class="text-muted">Skladatel:</strong>
                                <span class="ms-2"><a
                                        href="{{ url_for('library.composer_detail', composer_id=composition.composer.id) }}">
                                    {{ composition.composer.first_name }} {{ composition.composer.last_name }}
                                </a></span>
                            </div>
                            <div class="mb-2">
                                <strong class="text-muted">Druh skladby:</strong>
                                <span class="ms-2">
                {% if composition.type == "chamber" %}Komorní
                {% elif composition.type == "orchestral" %}Orchestrální
                {% endif %}
              </span>
                            </div>
                            <div class="mb-2">
                                <strong class="text-muted">Rok:</strong>
                                <span class="ms-2">{{ composition.year }}</span>
                            </div>
                            <div class="mb-2">
                                <strong class="text-muted">Délka:</strong>
                                <span class="ms-2">{{ composition.durata }} minut</span>
                            </div>

                            {% if composition.description %}
                                <div class="mt-4">
                                    <h6 class="text-muted">Popis</h6>
                                    <p class="text-muted small mb-0">{{ composition.description }}</p>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Right column -->
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Instrumentace</h6>
                            <div class="bg-light p-3 rounded">
                                {% if composition.type == "chamber" %}
                                    <p class="mb-0">{{ composition.chamber_instrumentation }}</p>
                                {% endif %}
                            </div>
                            <div class="mt-2">
                                {% for instrumentation in composition.instrumentation_entries %}
                                    <span class="badge rounded-pill text-bg-light text-decoration-none">{% if instrumentation.position %}
                                        {{ instrumentation.position }}. {% endif %}{{ instrumentation.instrument.name }}
                                    </span>{% endfor %}
                            </div>
                        </div>
                    </div>

                    {# Uncomment to show related events #}
                    {#
        <div class="mt-5">
          <h6 class="text-muted mb-3">Související události</h6>
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead class="table-light">
                <tr>
                  <th>Název</th>
                  <th>Typ</th>
                  <th>Datum</th>
                  <th>Místo</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Zkouška orchestru</td>
                  <td><span class="badge bg-primary bg-opacity-10 text-primary">Zkouška</span></td>
                  <td>10. června 2023, 18:00</td>
                  <td>Zkušebna ZUŠ</td>
                </tr>
                <tr>
                  <td>Mozartův večer</td>
                  <td><span class="badge bg-success bg-opacity-10 text-success">Koncert</span></td>
                  <td>15. června 2023, 19:00</td>
                  <td>Městské divadlo</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        #}
                </div>
            </div>

            {% if composition.ensemble_links %}
                <div class="card shadow-sm mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-users me-2 text-secondary"></i>Soubory, které skladbu hrály
                        </h5>
                        <span class="badge bg-light text-dark border">
                {{ composition.ensemble_links|length }} soubor{{ 'ů' if composition.ensemble_links|length != 1 else '' }}
            </span>
                    </div>

                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm align-middle mb-0">
                                <thead class="table-light text-uppercase small text-muted">
                                <tr>
                                    <th style="width:30%">Soubor</th>
                                    <th style="width:45%">Hráči</th>
                                    <th style="width:15%">Semestr</th>
                                    <th style="width:10%">Rok</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for link in latest_links %}
                                    <tr>
                                        <!-- Ensemble -->
                                        <td>
                                            <a href="{{ url_for('ensemble.ensemble_detail', ensemble_id=link.ensemble.id) }}"
                                               class="fw-semibold text-decoration-none text-dark">
                                                {{ link.ensemble.name }}
                                            </a>
                                            {% if link.ensemble.instrumentation %}
                                                <div class="small text-muted">{{ link.ensemble.instrumentation }}</div>
                                            {% endif %}
                                        </td>

                                        <!-- Players -->
                                        <td>
                                            {% if link.ensemble.player_links %}
                                                <div class="d-flex flex-wrap gap-1">
                                                    {% for ep in link.ensemble.player_links %}
                                                        {% set p = ep.player %}
                                                        <span class="badge rounded-pill bg-light text-dark border fw-normal">
                                                {{ p.first_name }} {{ p.last_name }}
                                                            {% if p.instrument %}
                                                                <span class="text-muted small">
                                                        ({{ p.instrument.abbreviation or p.instrument.name }})
                                                    </span>
                                                            {% endif %}
                                            </span>
                                                    {% endfor %}
                                                </div>
                                            {% else %}
                                                <span class="text-muted small">— bez hráčů —</span>
                                            {% endif %}
                                        </td>

                                        <!-- Semester -->
                                        <td>
                                            {% if "letní" in link.semester.name|lower %}
                                                <span class="badge bg-info text-dark border">
                                        <i class="fas fa-sun me-1"></i>{{ link.semester.name }}
                                    </span>
                                            {% elif "zimní" in link.semester.name|lower %}
                                                <span class="badge bg-primary text-light border">
                                        <i class="fas fa-snowflake me-1"></i>{{ link.semester.name }}
                                    </span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ link.semester.name }}</span>
                                            {% endif %}
                                        </td>

                                        <!-- Academic Year -->
                                        <td class="text-muted small">
                                            {{ link.semester.academic_year.name }}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endif %}


        </div>
    </main>
{% endblock %}
