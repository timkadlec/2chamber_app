{% extends 'base.html' %}
{% block title %}
    Studenti
{% endblock %}
{% block content %}
    <main>
        {% set active = "students" %}
        <div class="container-xl pb-4">
            <h1 class="text-secondary">Studenti</h1>
            <p>Přehled studentů na aktuálně vybraný semestr. Lze filtrovat podle zapsaných předmětů, nástroje i podle
                jména.</p>
        </div>


        <div class="container-xl">


            <!-- Table Wrapper -->
            <div class="card shadow-sm mb-4">
                <!-- Filters (optional, create _student_filters.html if needed) -->
                {% include "partials/_student_filters.html" ignore missing %}
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead class="table-light text-uppercase small text-muted">
                        <tr>
                            <th>Jméno studenta</th>
                            <th class="d-none d-md-table-cell">Osobní číslo</th>
                            <th class="d-none d-md-table-cell">Hlavní nástroj</th>
                            <th class="d-none d-lg-table-cell">E-mail</th>
                            <th class="d-none d-lg-table-cell">Telefon</th>
                            <th class="d-none d-sm-table-cell">Soubory</th>
                            <th class="text-end">Akce</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for student in students %}
                            <tr>
                                <td>
                                    <div class="fw-semibold text-dark">
                                        <a href="{{ url_for('students.student_detail', student_id=student.id, **request.args) }}">
                                            {{ student.full_name }}
                                        </a>

                                        {% if student.has_erasmus_in_semester(session['semester_id']|int) %}
                                            <img src="{{ url_for('static', filename='images/Erasmus_Logo.svg') }}"
                                                 alt="Erasmus+ logo" style="max-width:5em; height:auto;">
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="d-none d-md-table-cell">
                                    {{ student.osobni_cislo or "—" }}
                                </td>
                                <td class="d-none d-md-table-cell">
                                    {{ student.main_instrument.name if student.main_instrument else "—" }}
                                </td>
                                <td class="d-none d-lg-table-cell">
                                    {{ student.email or "—" }}
                                </td>
                                <td class="d-none d-lg-table-cell">
                                    {{ student.phone_number or "—" }}
                                </td>
                                <td class="d-none d-sm-table-cell">
                                    {% set count = student.player.ensemble_count_in_semester(current_semester.id) %}

                                    {% if count == 0 %}
                                        {% set percent, color, label = (0, "bg-danger", "0") %}
                                    {% elif count == 1 %}
                                        {% set percent, color, label = (25, "bg-success", "1") %}
                                    {% elif count == 2 %}
                                        {% set percent, color, label = (50, "bg-warning text-dark", "2") %}
                                    {% elif count == 3 %}
                                        {% set percent, color, label = (75, "bg-info text-dark", "3") %}
                                    {% else %}
                                        {% set percent, color, label = (100, "bg-danger", count|string) %}
                                    {% endif %}

                                    <div class="progress" style="height: 1.5rem; width: 100px;">
                                        <div class="progress-bar {{ color }}" role="progressbar"
                                             style="width: {{ percent }}%;" aria-valuenow="{{ percent }}"
                                             aria-valuemin="0" aria-valuemax="100">
                                            {{ label }}
                                        </div>
                                    </div>
                                </td>

                                <td class="text-end">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{{ url_for('students.student_detail', student_id=student.id, **request.args) }}"
                                           class="btn btn-outline-primary" title="Detail">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {#<a href="#"
                                           class="btn btn-outline-primary" title="Upravit">
                                            <i class="fas fa-edit"></i>
                                        </a>#}
                                        {% if current_user.has_permission('st_can_delete') %}
                                            <button type="button"
                                                    class="btn btn-outline-danger"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#deleteStudentModal{{ student.id }}"
                                                    title="Smazat">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        {% endif %}
                                    </div>

                                    <!-- Delete modal -->
                                    {% if current_user.has_permission('st_can_delete') %}
                                        <div class="modal fade" id="deleteStudentModal{{ student.id }}" tabindex="-1"
                                             aria-labelledby="deleteStudentModal{{ student.id }}Label"
                                             aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h1 class="modal-title fs-5"
                                                            id="deleteStudentModal{{ student.id }}Label">
                                                            Smazat studenta
                                                        </h1>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                                aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body text-start">
                                                        Opravdu si přejete smazat studenta
                                                        <b>{{ student.full_name }}</b>?
                                                    </div>
                                                    <div class="modal-footer">
                                                        <form action="#"
                                                              method="post" class="d-inline">
                                                            <button type="button" class="btn btn-secondary"
                                                                    data-bs-dismiss="modal">Close
                                                            </button>
                                                            <button type="submit" class="btn btn-danger">Smazat</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="card-footer bg-white">
                    <div class="d-flex flex-column flex-md-row align-items-center justify-content-between">
                        <div class="text-muted small">
                            Zobrazeno
                            <span class="fw-semibold">{{ pagination.page * pagination.per_page - pagination.per_page + 1 }}</span>
                            až
                            <span class="fw-semibold">
                {{ pagination.page * pagination.per_page if pagination.total > pagination.page * pagination.per_page else pagination.total }}
            </span>
                            z
                            <span class="fw-semibold">{{ pagination.total }}</span>
                            studentů
                        </div>
                        <nav aria-label="Stránkování">
                            <ul class="pagination pagination-sm mb-0 mt-3 mt-md-0">
                                {% if pagination.has_prev %}
                                    <li class="page-item">
                                        <a class="page-link"
                                           href="{{ url_for('students.index',
                                            page=pagination.prev_num,
                                            q=request.args.get('q'),
                                            instrument_id=request.args.get('instrument_id'),
                                            subject_id=request.args.get('subject_id'),
                                            active=request.args.get('active')) }}"
                                           aria-label="Předchozí">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                {% endif %}
                                {% for p in range(1, pagination.pages + 1) %}
                                    <li class="page-item {% if pagination.page == p %}active{% endif %}">
                                        <a class="page-link"
                                           href="{{ url_for('students.index',
                                            page=p,
                                            q=request.args.get('q'),
                                            instrument_id=request.args.get('instrument_id'),
                                            subject_id=request.args.get('subject_id'),
                                            active=request.args.get('active')) }}">{{ p }}</a>
                                    </li>
                                {% endfor %}
                                {% if pagination.has_next %}
                                    <li class="page-item">
                                        <a class="page-link"
                                           href="{{ url_for('students.index',
                                            page=pagination.next_num,
                                            q=request.args.get('q'),
                                            instrument_id=request.args.get('instrument_id'),
                                            subject_id=request.args.get('subject_id'),
                                            active=request.args.get('active')) }}"
                                           aria-label="Další">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                </div>

            </div>
        </div>
    </main>
{% endblock %}
